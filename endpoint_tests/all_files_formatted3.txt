=== Файл: App.css ===
```css
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
```

=== Файл: vite-env.d.ts ===
```typescript
/// <reference types="vite/client" />
```

=== Файл: App.tsx ===
```typescript
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'
import { AppRouter } from './router/AppRouter'
import './styles/base.module.scss'

const queryClient = new QueryClient({
	defaultOptions: {
		queries: {
			refetchOnWindowFocus: false,
			retry: 1,
		},
	},
})

export function App() {
	return (
		<QueryClientProvider client={queryClient}>
			<AppRouter />
			<ReactQueryDevtools initialIsOpen={false} />
		</QueryClientProvider>
	)
}
```

=== Файл: main.tsx ===
```typescript
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import { App } from './App.tsx'

createRoot(document.getElementById('root')!).render(
	<StrictMode>
		<App />
	</StrictMode>
)
```

=== Файл: pages/HomePage/HomePage.tsx ===
```typescript
import styles from './HomePage.module.scss'

export default function HomePage() {
	return (
		<div className={styles.homeContainer}>
			<h1>Главная страница</h1>
			<p>Тут будет контент...</p>
		</div>
	)
}
```

=== Файл: pages/ProfilePage/ProfilePage.tsx ===
```typescript
import { AddAnimalModal } from '@/components/AddAnimalModal/AddAnimalModal'
import { UserAvatarUpload } from '@/components/UserAvatarUpload/UserAvatarUpload'
import { useUserAnimals } from '@/features/animal/hooks/useUserAnimals'
import { useUser } from '@/features/user/hooks/useUser'
import { PlusOutlined } from '@ant-design/icons'
import { Button, Card, Form, Input, message } from 'antd'
import { useEffect, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import styles from './ProfilePage.module.scss'

interface ProfileFormValues {
	firstName?: string
	lastName?: string
	city?: string
	aboutMe?: string
}

export default function ProfilePage() {
	const [isModalOpen, setIsModalOpen] = useState(false)
	const { currentUser, isPending, updateUser } = useUser()
	const {
		data: animals = [],
		isPending: isAnimalsLoading,
		refetch,
	} = useUserAnimals()
	const [form] = Form.useForm<ProfileFormValues>()
	const navigate = useNavigate()
	useEffect(() => {
		if (currentUser) {
			form.setFieldsValue({
				firstName: currentUser.firstName,
				lastName: currentUser.lastName,
				city: currentUser.city,
				aboutMe: currentUser.aboutMe,
			})
		}
	}, [currentUser, form])

	const onFinish = async (values: ProfileFormValues) => {
		try {
			await updateUser(values)
			message.success('Профиль обновлён!')
		} catch (error) {
			message.error('Ошибка обновления профиля')
			console.error('Update error:', error)
		}
	}

	const handleAnimalCreated = () => {
		refetch()
		setIsModalOpen(false)
	}

	if (isPending) return <div>Загрузка профиля...</div>

	return (
		<div className={styles.profileContainer}>
			<h1>Профиль</h1>

			<div className={styles.profileSection}>
				<UserAvatarUpload currentPhotoUrl={currentUser?.photoUrl} />

				<Form form={form} onFinish={onFinish} layout='vertical'>
					<Form.Item name='firstName' label='Имя'>
						<Input />
					</Form.Item>
					<Form.Item name='lastName' label='Фамилия'>
						<Input />
					</Form.Item>
					<Form.Item name='city' label='Город'>
						<Input />
					</Form.Item>
					<Form.Item name='aboutMe' label='О себе'>
						<Input.TextArea rows={4} />
					</Form.Item>
					<Button type='primary' htmlType='submit'>
						Сохранить
					</Button>
				</Form>
			</div>

			<div className={styles.animalsSection}>
				<div className={styles.animalsHeader}>
					<h2>Мои животные</h2>
					<Button
						type='primary'
						icon={<PlusOutlined />}
						onClick={() => setIsModalOpen(true)}
					>
						Добавить
					</Button>
				</div>

				{isAnimalsLoading ? (
					<div>Загрузка животных...</div>
				) : (
					<div className={styles.animalsGrid}>
						{animals.map(animal => (
							<Card
								key={animal.id}
								hoverable
								onClick={() => navigate(`/animals/${animal.id}`)}
								cover={
									animal.photos?.[0] ? (
										<img
											alt={animal.name}
											src={animal.photos[0]}
											className={styles.animalImage}
										/>
									) : (
										<div className={styles.noImage}>Нет фото</div>
									)
								}
							>
								<Card.Meta title={animal.name} />
							</Card>
						))}
					</div>
				)}
			</div>

			<AddAnimalModal
				open={isModalOpen}
				onClose={() => setIsModalOpen(false)}
				onAnimalCreated={handleAnimalCreated}
			/>
		</div>
	)
}
```

=== Файл: pages/ActivateAccountPage/ActivateAccountPage.tsx ===
```typescript
import { useAuth } from '@/features/auth/hooks/useAuth'
import { Button, Form, Input, message } from 'antd'
import { useNavigate } from 'react-router-dom'
import styles from './ActivateAccountPage.module.scss'

export default function ActivateAccountPage() {
	const [form] = Form.useForm()
	const { activate, isActivating } = useAuth()
	const navigate = useNavigate()

	const onFinish = async (values: { token: string }) => {
		try {
			await activate(values.token)
			message.success('Аккаунт успешно активирован!')
			navigate('/auth/login')
		} catch (error) {
			message.error(`Ошибка активации: ${error ?? 'Неизвестная'}`)
		}
	}

	return (
		<div className={styles.activateContainer}>
			<h1>Активация аккаунта</h1>
			<p>Пожалуйста, введите код активации, высланный на вашу почту.</p>

			<Form
				form={form}
				layout='vertical'
				onFinish={onFinish}
				className={styles.activateForm}
			>
				<Form.Item
					label='Код активации (token)'
					name='token'
					rules={[{ required: true, message: 'Введите код из почты' }]}
				>
					<Input />
				</Form.Item>

				<Form.Item>
					<Button type='primary' htmlType='submit' loading={isActivating}>
						Активировать
					</Button>
				</Form.Item>
			</Form>
		</div>
	)
}
```

=== Файл: pages/LoginPage/LoginPage.tsx ===
```typescript
import { useAuth } from '@/features/auth/hooks/useAuth'
import { Button, Form, Input, message } from 'antd'
import axios from 'axios'
import { useNavigate } from 'react-router-dom'
import styles from './LoginPage.module.scss'

interface LoginFormValues {
	identifier: string
	password: string
}

export default function LoginPage() {
	const [form] = Form.useForm<LoginFormValues>()
	const { login, isLoggingIn } = useAuth()
	const navigate = useNavigate()

	async function onFinish(values: LoginFormValues) {
		try {
			await login({
				indentifier: values.identifier,
				password: values.password,
			})
			message.success('Авторизация прошла успешно!')
			navigate('/')
		} catch (error: unknown) {
			if (axios.isAxiosError(error)) {
				// Можем достать текст ошибки из error.response?.data или error.message
				const serverMsg = error.response?.data?.error || error.message
				message.error(`Ошибка авторизации: ${serverMsg}`)
			} else {
				message.error('Неизвестная ошибка при авторизации.')
			}
		}
	}

	return (
		<div className={styles.loginContainer}>
			<h1>Авторизация</h1>
			<Form
				form={form}
				layout='vertical'
				onFinish={onFinish}
				className={styles.loginForm}
			>
				<Form.Item
					label='Email или Username'
					name='identifier'
					rules={[{ required: true, message: 'Введите идентификатор' }]}
				>
					<Input placeholder='Введите email или username' />
				</Form.Item>

				<Form.Item
					label='Пароль'
					name='password'
					rules={[{ required: true, message: 'Введите пароль' }]}
				>
					<Input.Password placeholder='Введите пароль' />
				</Form.Item>

				<Form.Item>
					<Button type='primary' htmlType='submit' loading={isLoggingIn}>
						Войти
					</Button>
				</Form.Item>
			</Form>
		</div>
	)
}
```

=== Файл: pages/DiaryPage/DiaryPage.tsx ===
```typescript
import styles from './DiaryPage.module.scss'

export default function DiaryPage() {
	return (
		<div className={styles.homeContainer}>
			<h1>Дневник страница</h1>
			<p>Тут будет контент...</p>
		</div>
	)
}
```

=== Файл: pages/NotFoundPage/NotFoundPage.tsx ===
```typescript
import styles from './NotFoundPage.module.scss'

export default function NotFoundPage() {
	return (
		<div className={styles.homeContainer}>
			<h1>NotFoundPage страница</h1>
			<p>Тут будет контент...</p>
		</div>
	)
}
```

=== Файл: pages/AnimalPage/AnimalPage.tsx ===
```typescript
import { FileUpload } from '@/components/FileUpload/FileUpload'
import { animalApi } from '@/features/animal/api/animalApi'
import { exportApi } from '@/features/animal/api/exportApi'
import {
	AnimalResponse,
	AnimalUpdateRequest,
} from '@/features/animal/api/types'
import {
	BookOutlined,
	DeleteOutlined,
	EditOutlined,
	EyeOutlined,
	FilePdfOutlined,
	PlusOutlined,
	UploadOutlined,
} from '@ant-design/icons'
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import {
	Button,
	Card,
	DatePicker,
	Form,
	Image,
	Input,
	message,
	Modal,
	Space,
	Typography,
} from 'antd'
import dayjs from 'dayjs'
import { useState } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import styles from './AnimalPage.module.scss'

const { Title, Text } = Typography

export const AnimalPage = () => {
	const { id } = useParams<{ id: string }>()
	const navigate = useNavigate()
	const queryClient = useQueryClient()
	const [form] = Form.useForm()
	const [isEditing, setIsEditing] = useState(false)
	const [isPhotoModalOpen, setIsPhotoModalOpen] = useState(false)
	const [selectedPhotoIndex, setSelectedPhotoIndex] = useState(0)
	const [newAttribute, setNewAttribute] = useState<{
		name: string
		value: string
	}>({ name: '', value: '' })

	// Получение данных животного
	const { data: animal, isPending } = useQuery<AnimalResponse>({
		queryKey: ['animal', id],
		queryFn: () => animalApi.getAnimal(Number(id!)),
	})

	// Мутации
	const updateAnimal = useMutation({
		mutationFn: (data: AnimalUpdateRequest) =>
			animalApi.updateAnimal(Number(id!), data),
		onSuccess: () => {
			message.success('Данные обновлены!')
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
			setIsEditing(false)
		},
	})

	const addPhoto = useMutation({
		mutationFn: (file: File) => animalApi.uploadAnimalPhoto(Number(id!), file),
		onSuccess: () => {
			message.success('Фото добавлено!')
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
		},
	})

	const deletePhoto = useMutation({
		mutationFn: (photoUrl: string) => animalApi.deleteAnimalPhoto(photoUrl),
		onSuccess: () => {
			message.success('Фото удалено!')
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
		},
	})

	const addDocument = useMutation({
		mutationFn: ({ file, type }: { file: File; type: string }) =>
			animalApi.uploadAnimalDocument(Number(id!), file, type),
		onSuccess: () => {
			message.success('Документ добавлен!')
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
		},
	})

	const deleteDocument = useMutation({
		mutationFn: (documentUrl: string) =>
			animalApi.deleteAnimalDocument(documentUrl),
		onSuccess: () => {
			message.success('Документ удален!')
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
		},
	})

	const addAttribute = useMutation({
		mutationFn: (data: { name: string; value: string }) =>
			animalApi.addAttribute(Number(id!), data),
		onSuccess: () => {
			message.success('Атрибут добавлен!')
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
			setNewAttribute({ name: '', value: '' })
		},
	})

	const deleteAttribute = useMutation({
		mutationFn: (attributeId: number) =>
			animalApi.deleteAttribute(Number(id!), attributeId),
		onSuccess: () => {
			message.success('Атрибут удален!')
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
		},
	})
	const exportToPdf = useMutation({
		mutationFn: () => exportApi.exportAnimalToPdf(Number(id!)),
		onSuccess: (pdfBlob: Blob) => {
			const url = window.URL.createObjectURL(pdfBlob)
			const link = document.createElement('a')
			link.href = url
			link.setAttribute('download', `animal_${animal?.name}_report.pdf`)
			document.body.appendChild(link)
			link.click()
			document.body.removeChild(link)

			// Освобождаем память
			setTimeout(() => {
				window.URL.revokeObjectURL(url)
			}, 100)
		},
		onError: error => {
			console.error('Export failed:', error)
			message.error('Не удалось экспортировать в PDF')
		},
	})
	// const exportToPdf = useMutation({
	// 	mutationFn: () => exportApi.exportAnimalToPdf(Number(id!)),
	// 	onSuccess: pdfData => {
	// 		const blob = new Blob([pdfData], { type: 'application/pdf' })
	// 		const url = window.URL.createObjectURL(blob)
	// 		const link = document.createElement('a')
	// 		link.href = url
	// 		link.setAttribute('download', `animal_${animal?.name}_report.pdf`)
	// 		document.body.appendChild(link)
	// 		link.click()
	// 		document.body.removeChild(link)
	// 	},
	// })
	const handleSave = () => {
		const values = form.getFieldsValue()
		updateAnimal.mutate({
			...values,
			birthDate: values.birthDate?.format('YYYY-MM-DD'),
		})
	}

	const handleAddAttribute = () => {
		if (!newAttribute.name || !newAttribute.value) {
			message.warning('Заполните название и значение атрибута')
			return
		}
		addAttribute.mutate(newAttribute)
	}

	const handleDeletePhoto = (photoUrl: string, e: React.MouseEvent) => {
		e.stopPropagation()
		deletePhoto.mutate(photoUrl)
	}

	const handleDeleteDocument = (documentUrl: string) => {
		deleteDocument.mutate(documentUrl)
	}

	if (isPending) return <div>Загрузка...</div>
	if (!animal) return <div>Животное не найдено</div>

	return (
		<div className={styles.container}>
			<Button onClick={() => navigate(-1)} className={styles.backButton}>
				Назад к списку
			</Button>
			<Space>
				<Button
					type='default'
					icon={<BookOutlined />}
					onClick={() => navigate(`/animals/${id}/diary`)}
				>
					Дневник
				</Button>
				<Button
					type='primary'
					icon={<FilePdfOutlined />}
					onClick={() => exportToPdf.mutate()}
					loading={exportToPdf.isPending}
				>
					Экспорт в PDF
				</Button>
			</Space>
			<Title level={2}>{animal.name}</Title>

			<div className={styles.sectionsContainer}>
				{/* Основная информация */}
				<Card
					title='Основная информация'
					extra={
						isEditing ? null : (
							<EditOutlined onClick={() => setIsEditing(true)} />
						)
					}
					className={styles.section}
				>
					{isEditing ? (
						<Form
							form={form}
							initialValues={{
								name: animal.name,
								description: animal.description,
								birthDate: animal.birthDate ? dayjs(animal.birthDate) : null,
								mass: animal.mass,
							}}
							layout='vertical'
						>
							<Form.Item name='name' label='Имя'>
								<Input />
							</Form.Item>
							<Form.Item name='description' label='Описание'>
								<Input.TextArea rows={3} />
							</Form.Item>
							<Form.Item name='birthDate' label='Дата рождения'>
								<DatePicker style={{ width: '100%' }} />
							</Form.Item>
							<Form.Item name='mass' label='Вес (кг)'>
								<Input type='number' />
							</Form.Item>
							<Space>
								<Button type='primary' onClick={handleSave}>
									Сохранить
								</Button>
								<Button onClick={() => setIsEditing(false)}>Отмена</Button>
							</Space>
						</Form>
					) : (
						<>
							<p>
								<Text strong>Описание:</Text> {animal.description || '—'}
							</p>
							<p>
								<Text strong>Дата рождения:</Text> {animal.birthDate || '—'}
							</p>
							<p>
								<Text strong>Вес:</Text>{' '}
								{animal.mass ? `${animal.mass} кг` : '—'}
							</p>
						</>
					)}
				</Card>

				{/* Атрибуты */}
				<Card
					title={
						<div className={styles.cardTitleWithButton}>
							<span>Атрибуты</span>
						</div>
					}
					className={styles.section}
				>
					{newAttribute.name !== undefined && (
						<div className={styles.newAttribute}>
							<Input
								placeholder='Название атрибута'
								value={newAttribute.name}
								onChange={e =>
									setNewAttribute({ ...newAttribute, name: e.target.value })
								}
							/>
							<Input
								placeholder='Значение'
								value={newAttribute.value}
								onChange={e =>
									setNewAttribute({ ...newAttribute, value: e.target.value })
								}
							/>
							<Button
								type='primary'
								icon={<PlusOutlined />}
								onClick={handleAddAttribute}
							>
								Добавить
							</Button>
							<Text type='secondary' className={styles.tip}>
								Примеры: Порода, Цвет, Особенности, Аллергии
							</Text>
						</div>
					)}

					<div className={styles.attributesList}>
						{animal.attributes.map(attr => (
							<div key={attr.id} className={styles.attributeItem}>
								<div className={styles.attributeContent}>
									<Text strong>{attr.name}:</Text> {attr.value || '—'}
								</div>
								<Button
									type='text'
									danger
									icon={<DeleteOutlined />}
									onClick={() => deleteAttribute.mutate(attr.id)}
									loading={deleteAttribute.isPending}
								/>
							</div>
						))}
						{animal.attributes.length === 0 && (
							<Text type='secondary'>Нет добавленных атрибутов</Text>
						)}
					</div>
				</Card>

				{/* Фотографии */}
				<Card title='Фотографии' className={styles.section}>
					<FileUpload
						beforeUpload={(file: File) => {
							addPhoto.mutate(file)
							return false
						}}
						accept='image/*'
						showUploadList={false}
						buttonText={'Добавить фото +'}
						buttonIcon={undefined}
					>
						<Button
							type='text'
							icon={<UploadOutlined className={styles.darkIcon} />}
						>
							Добавить фото
						</Button>
					</FileUpload>

					<div className={styles.photosGrid}>
						{animal.photos.map((photo, index) => (
							<div key={index} className={styles.photoWrapper}>
								<Image
									src={photo}
									alt={`Фото ${animal.name}`}
									width={150}
									height={150}
									preview={{
										visible: false,
										onVisibleChange: visible => {
											if (visible) {
												setSelectedPhotoIndex(index)
												setIsPhotoModalOpen(true)
											}
										},
									}}
								/>
								<div className={styles.photoActions}>
									<EyeOutlined
										className={styles.viewIcon}
										onClick={() => {
											setSelectedPhotoIndex(index)
											setIsPhotoModalOpen(true)
										}}
									/>
									<DeleteOutlined
										className={styles.deleteIcon}
										onClick={e => handleDeletePhoto(photo, e)}
									/>
								</div>
							</div>
						))}
						{animal.photos.length === 0 && (
							<Text type='secondary'>Нет добавленных фото</Text>
						)}
					</div>
				</Card>

				{/* Документы */}
				<Card title='Документы' className={styles.section}>
					<FileUpload
						beforeUpload={(file: File) => {
							addDocument.mutate({ file, type: 'OTHER' })
							return false
						}}
						accept='.pdf,.doc,.docx'
						showUploadList={false}
						buttonText={'Добавить документ +'}
						buttonIcon={undefined}
					>
						<Button
							type='text'
							icon={<UploadOutlined className={styles.darkIcon} />}
						>
							Добавить документ
						</Button>
					</FileUpload>

					<div className={styles.documentsList}>
						{animal.documents.map((doc, index) => (
							<div key={index} className={styles.documentItem}>
								<a href={doc} target='_blank' rel='noopener noreferrer'>
									Документ {index + 1}
								</a>
								<Button
									type='text'
									danger
									icon={<DeleteOutlined />}
									onClick={() => handleDeleteDocument(doc)}
									loading={deleteDocument.isPending}
								/>
							</div>
						))}
						{animal.documents.length === 0 && (
							<Text type='secondary'>Нет добавленных документов</Text>
						)}
					</div>
				</Card>
			</div>

			{/* Модальное окно просмотра фото */}
			<Modal
				open={isPhotoModalOpen}
				footer={null}
				onCancel={() => setIsPhotoModalOpen(false)}
				width='80vw'
				bodyStyle={{ padding: 0 }}
			>
				<div className={styles.photoModal}>
					<Image
						src={animal.photos[selectedPhotoIndex]}
						alt={`Фото ${animal.name}`}
						style={{ maxHeight: '80vh', objectFit: 'contain' }}
					/>
					{animal.photos.length > 1 && (
						<div className={styles.photoNavigation}>
							<Button
								onClick={() =>
									setSelectedPhotoIndex(
										prev =>
											(prev - 1 + animal.photos.length) % animal.photos.length
									)
								}
							>
								Назад
							</Button>
							<span>
								{selectedPhotoIndex + 1} / {animal.photos.length}
							</span>
							<Button
								onClick={() =>
									setSelectedPhotoIndex(
										prev => (prev + 1) % animal.photos.length
									)
								}
							>
								Вперед
							</Button>
						</div>
					)}
				</div>
			</Modal>
		</div>
	)
}
```

=== Файл: pages/RegisterPage/RegisterPage.tsx ===
```typescript
import { useAuth } from '@/features/auth/hooks/useAuth'
import { Button, Form, Input, message } from 'antd'
import axios from 'axios'
import { useNavigate } from 'react-router-dom'
import styles from './RegisterPage.module.scss'

interface RegisterFormValues {
	username: string
	email: string
	password: string
}

export default function RegisterPage() {
	const [form] = Form.useForm<RegisterFormValues>()
	const { register, isRegistering } = useAuth()
	const navigate = useNavigate()

	async function onFinish(values: RegisterFormValues) {
		try {
			await register({
				username: values.username,
				email: values.email,
				password: values.password,
			})
			message.success(
				'Регистрация прошла успешно! Проверьте почту для активации.'
			)
			navigate('/auth/activate')
		} catch (error: unknown) {
			if (axios.isAxiosError(error)) {
				const serverMsg = error.response?.data?.error || error.message
				message.error(`Ошибка регистрации: ${serverMsg}`)
			} else {
				message.error('Неизвестная ошибка при регистрации.')
			}
		}
	}

	return (
		<div className={styles.registerContainer}>
			<h1>Регистрация</h1>
			<Form
				form={form}
				layout='vertical'
				onFinish={onFinish}
				className={styles.registerForm}
			>
				<Form.Item
					label='Имя пользователя'
					name='username'
					rules={[{ required: true, message: 'Введите имя пользователя' }]}
				>
					<Input placeholder='Введите имя пользователя' />
				</Form.Item>

				<Form.Item
					label='Email'
					name='email'
					rules={[
						{ required: true, message: 'Введите email' },
						{ type: 'email', message: 'Неверный формат email' },
					]}
				>
					<Input placeholder='Введите email' />
				</Form.Item>

				<Form.Item
					label='Пароль'
					name='password'
					rules={[{ required: true, message: 'Введите пароль' }]}
				>
					<Input.Password placeholder='Введите пароль' />
				</Form.Item>

				<Form.Item>
					<Button type='primary' htmlType='submit' loading={isRegistering}>
						Зарегистрироваться
					</Button>
				</Form.Item>
			</Form>
		</div>
	)
}
```

=== Файл: pages/AnimalDiaryPage/AnimalDiaryPage.tsx ===
```typescript
import { FileUpload } from '@/components/FileUpload/FileUpload'
import {
	AttributeResponse,
	DocumentResponse,
} from '@/features/animal/api/types'
import { useAnimal } from '@/features/animal/hooks/useAnimal'
import { diaryApi } from '@/features/diary/api/diaryApi'
import { PlusOutlined, UploadOutlined } from '@ant-design/icons'
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { Button, Calendar, Card, Form, Image, Input, message } from 'antd'
import Title from 'antd/es/typography/Title'
import dayjs from 'dayjs'
import { useState } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import styles from './AnimalDiaryPage.module.scss'

export const AnimalDiaryPage = () => {
	const { id } = useParams<{ id: string }>()
	const navigate = useNavigate()
	const queryClient = useQueryClient()
	const [form] = Form.useForm()
	const [selectedDate, setSelectedDate] = useState<dayjs.Dayjs>(dayjs())
	const [newAttribute, setNewAttribute] = useState<{
		name: string
		value: string
	}>({ name: '', value: '' })

	// Получаем данные животного
	const { animal } = useAnimal(Number(id))

	// Получение записей дневника
	const { data: diaryEntriesResponse } = useQuery({
		queryKey: ['animalDiary', id],
		queryFn: () => diaryApi.getStatusLogs(Number(id!)),
	})

	const diaryEntries = diaryEntriesResponse?.data || []

	// Получение конкретной записи для выбранной даты
	const currentEntry = diaryEntries.find(entry =>
		dayjs(entry.logDate).isSame(selectedDate, 'day')
	)

	// Мутации
	const createEntry = useMutation({
		mutationFn: (notes: string = 'Запись') =>
			diaryApi.addStatusLog(Number(id!), {
				notes,
				logDate: selectedDate.format('YYYY-MM-DD'),
			}),
		onSuccess: () => {
			message.success('Запись создана!')
			queryClient.invalidateQueries({ queryKey: ['animalDiary', id] })
		},
	})

	const updateEntry = useMutation({
		mutationFn: (notes: string) => {
			if (!currentEntry?.id) {
				throw new Error('Entry ID is missing')
			}
			return diaryApi.updateStatusLog(Number(id!), currentEntry.id, { notes })
		},
		onSuccess: () => {
			message.success('Запись обновлена!')
			queryClient.invalidateQueries({ queryKey: ['animalDiary', id] })
		},
	})

	const addPhoto = useMutation({
		mutationFn: (file: File) => {
			if (!currentEntry?.id) {
				throw new Error('Entry ID is missing')
			}
			return diaryApi.addStatusLogPhoto(Number(id!), currentEntry.id, file)
		},
		onSuccess: () => {
			message.success('Фото добавлено!')
			queryClient.invalidateQueries({ queryKey: ['animalDiary', id] })
		},
	})

	const addDocument = useMutation({
		mutationFn: ({ file, type }: { file: File; type: string }) => {
			if (!currentEntry?.id) {
				throw new Error('Entry ID is missing')
			}
			return diaryApi.addStatusLogDocument(
				Number(id!),
				currentEntry.id,
				file,
				type
			)
		},
		onSuccess: () => {
			message.success('Документ добавлен!')
			queryClient.invalidateQueries({ queryKey: ['animalDiary', id] })
		},
	})

	const addAttribute = useMutation({
		mutationFn: (data: { name: string; value: string }) => {
			if (!currentEntry?.id) {
				throw new Error('Entry ID is missing')
			}
			return diaryApi.addStatusLogAttribute(Number(id!), currentEntry.id, data)
		},
		onSuccess: () => {
			message.success('Атрибут добавлен!')
			queryClient.invalidateQueries({ queryKey: ['animalDiary', id] })
			setNewAttribute({ name: '', value: '' })
		},
	})

	const updateAttribute = useMutation({
		mutationFn: ({
			attrId,
			data,
		}: {
			attrId: number
			data: { name?: string; value?: string }
		}) => {
			if (!currentEntry?.id) {
				throw new Error('Entry ID is missing')
			}
			return diaryApi.updateStatusLogAttribute(
				Number(id!),
				currentEntry.id,
				attrId,
				data
			)
		},
		onSuccess: () => {
			message.success('Атрибут обновлен!')
			queryClient.invalidateQueries({ queryKey: ['animalDiary', id] })
		},
	})

	const handleSave = () => {
		const notes = form.getFieldValue('notes')
		if (currentEntry) {
			updateEntry.mutate(notes)
		} else {
			createEntry.mutate(notes)
		}
	}

	const handleAddAttribute = () => {
		if (!newAttribute.name || !newAttribute.value) {
			message.warning('Заполните название и значение атрибута')
			return
		}
		addAttribute.mutate(newAttribute)
	}

	const dateCellRender = (value: dayjs.Dayjs) => {
		const hasEntry = diaryEntries.some(entry =>
			dayjs(entry.logDate).isSame(value, 'day')
		)

		return hasEntry ? <div className={styles.calendarDayWithEntry} /> : null
	}

	return (
		<div className={styles.container}>
			<Button
				onClick={() => navigate(`/animals/${id}`)}
				className={styles.backButton}
			>
				Назад к животному
			</Button>

			<Title level={2}>Дневник: {animal?.name}</Title>

			<div className={styles.calendarSection}>
				<Calendar
					value={selectedDate}
					onChange={date => setSelectedDate(date)}
					dateCellRender={dateCellRender}
				/>
			</div>

			{selectedDate && (
				<Card
					title={`Запись за ${selectedDate.format('DD.MM.YYYY')}`}
					className={styles.entrySection}
				>
					{currentEntry ? (
						<>
							<Form
								form={form}
								initialValues={{ notes: currentEntry.notes }}
								layout='vertical'
							>
								<Form.Item name='notes' label='Заметки'>
									<Input.TextArea rows={4} />
								</Form.Item>
								<Button type='primary' onClick={handleSave}>
									Сохранить
								</Button>
							</Form>

							{/* Блок с фото */}
							<div className={styles.photosSection}>
								<h3>Фото</h3>
								<FileUpload
									beforeUpload={(file: File) => {
										addPhoto.mutate(file)
										return false
									}}
									accept='image/*'
									showUploadList={false}
									buttonText={'Добавить фото +'}
									buttonIcon={undefined}
								>
									<Button icon={<UploadOutlined />}>Добавить фото</Button>
								</FileUpload>
								<div className={styles.photosGrid}>
									{currentEntry.photos.map((photo: string, index: number) => (
										<Image
											key={index}
											src={photo}
											width={100}
											height={100}
											alt={`Фото записи ${index + 1}`}
										/>
									))}
								</div>
							</div>

							{/* Блок с документами */}
							<div className={styles.documentsSection}>
								<h3>Документы</h3>
								<FileUpload
									beforeUpload={(file: File) => {
										addDocument.mutate({ file, type: 'OTHER' })
										return false
									}}
									accept='.pdf,.doc,.docx'
									showUploadList={false}
									buttonText={'Добавить документ +'}
									buttonIcon={undefined}
								>
									<Button icon={<UploadOutlined />}>Добавить документ</Button>
								</FileUpload>
								<div className={styles.documentsList}>
									{currentEntry.documents.map(
										(doc: DocumentResponse, index: number) => (
											<div key={index} className={styles.documentItem}>
												<a
													href={doc.url}
													target='_blank'
													rel='noopener noreferrer'
												>
													Документ {index + 1}
												</a>
											</div>
										)
									)}
								</div>
							</div>

							{/* Блок с атрибутами */}
							<div className={styles.attributesSection}>
								<h3>Атрибуты</h3>
								<div className={styles.newAttribute}>
									<Input
										placeholder='Название атрибута'
										value={newAttribute.name}
										onChange={e =>
											setNewAttribute({ ...newAttribute, name: e.target.value })
										}
									/>
									<Input
										placeholder='Значение'
										value={newAttribute.value}
										onChange={e =>
											setNewAttribute({
												...newAttribute,
												value: e.target.value,
											})
										}
									/>
									<Button
										type='primary'
										icon={<PlusOutlined />}
										onClick={handleAddAttribute}
									>
										Добавить
									</Button>
								</div>
								<div className={styles.attributesList}>
									{currentEntry.attributes.map((attr: AttributeResponse) => (
										<div key={attr.id} className={styles.attributeItem}>
											<Input
												value={attr.name}
												onChange={e =>
													updateAttribute.mutate({
														attrId: attr.id,
														data: { name: e.target.value },
													})
												}
											/>
											<Input
												value={attr.value || ''}
												onChange={e =>
													updateAttribute.mutate({
														attrId: attr.id,
														data: { value: e.target.value },
													})
												}
											/>
										</div>
									))}
								</div>
							</div>
						</>
					) : (
						<>
							<p>Запись на эту дату отсутствует</p>
							<Button
								type='primary'
								icon={<PlusOutlined />}
								onClick={() => createEntry.mutate('Новая запись!')}
							>
								Создать запись
							</Button>
						</>
					)}
				</Card>
			)}
		</div>
	)
}
```

=== Файл: router/AppRouter.tsx ===
```typescript
import { createBrowserRouter, RouterProvider } from 'react-router-dom'

import { AuthLayout } from '@/layouts/AuthLayout/AuthLayout'
import { MainLayout } from '@/layouts/MainLayout/MainLayout'

import ActivateAccountPage from '@/pages/ActivateAccountPage/ActivateAccountPage'
import { AnimalDiaryPage } from '@/pages/AnimalDiaryPage/AnimalDiaryPage'
import { AnimalPage } from '@/pages/AnimalPage/AnimalPage'
import DiaryPage from '@/pages/DiaryPage/DiaryPage'
import HomePage from '@/pages/HomePage/HomePage'
import LoginPage from '@/pages/LoginPage/LoginPage'
import NotFoundPage from '@/pages/NotFoundPage/NotFoundPage'
import ProfilePage from '@/pages/ProfilePage/ProfilePage'
import RegisterPage from '@/pages/RegisterPage/RegisterPage'

const router = createBrowserRouter([
	{
		path: '/auth',
		element: <AuthLayout />,
		children: [
			{ path: 'login', element: <LoginPage /> },
			{ path: 'register', element: <RegisterPage /> },
			{ path: 'activate', element: <ActivateAccountPage /> },
			{ path: '*', element: <NotFoundPage /> },
		],
	},
	{
		path: '/',
		element: <MainLayout />,
		children: [
			{ index: true, element: <HomePage /> },
			{
				path: 'animals/:id/diary',
				element: <AnimalDiaryPage />,
			},
			{ path: 'animals/:id', element: <AnimalPage /> },
			{ path: 'diary', element: <DiaryPage /> },
			{ path: 'profile', element: <ProfilePage /> },
			{ path: '*', element: <NotFoundPage /> },
		],
	},
])

export function AppRouter() {
	return <RouterProvider router={router} />
}
```

=== Файл: components/AddAnimalModal/AddAnimalModal.tsx ===
```typescript
import { animalApi } from '@/features/animal/api/animalApi'
import { AnimalCreateRequest } from '@/features/animal/api/types'
import { useAnimal } from '@/features/animal/hooks/useAnimal'
import { PlusOutlined, UploadOutlined } from '@ant-design/icons'
import { Button, DatePicker, Form, Input, message, Modal, Select } from 'antd'
import { RcFile } from 'antd/es/upload'
import dayjs from 'dayjs'
import { useState } from 'react'
import { FileUpload } from '../FileUpload/FileUpload'
import styles from './AddAnimalModal.module.scss'

interface AddAnimalModalProps {
	open: boolean
	onClose: () => void
	onAnimalCreated: () => void
}

interface AddAnimalFormValues {
	name: string
	description?: string
	birthDate?: dayjs.Dayjs
	mass?: string
}

const documentTypes = [
	{ value: 'PASSPORT', label: 'Паспорт' },
	{ value: 'VACCINATION', label: 'Вакцинация' },
	{ value: 'MEDICAL', label: 'Медкарта' },
	{ value: 'OTHER', label: 'Другое' },
]

const acceptedFileTypes = {
	photo: ['image/jpeg', 'image/png', 'image/webp'],
	document: [
		'application/pdf',
		'application/msword',
		'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
	],
}

export const AddAnimalModal = ({
	open,
	onClose,
	onAnimalCreated,
}: AddAnimalModalProps) => {
	const [form] = Form.useForm<AddAnimalFormValues>()
	const [photoFile, setPhotoFile] = useState<RcFile | null>(null)
	const [documentFile, setDocumentFile] = useState<RcFile | null>(null)
	const [documentType, setDocumentType] = useState<string>('PASSPORT')
	const { createAnimal, isCreating } = useAnimal()

	const handleSubmit = async () => {
		try {
			const values = await form.validateFields()

			// 1. Создаем животное
			const animalData: AnimalCreateRequest = {
				name: values.name,
				description: values.description,
				birthDate: values.birthDate?.format('YYYY-MM-DD'),
				mass: values.mass ? Number(values.mass) : undefined,
				attributes: [],
			}

			const animal = await createAnimal(animalData)

			// 2. Загружаем файлы если есть
			const uploads = []

			if (photoFile) {
				uploads.push(
					animalApi.uploadAnimalPhoto(animal.id, photoFile).then(({ url }) => {
						message.success('Фото успешно загружено!')
						return url
					})
				)
			}

			if (documentFile) {
				uploads.push(
					animalApi
						.uploadAnimalDocument(animal.id, documentFile, documentType)
						.then(({ url }) => {
							message.success('Документ успешно загружен!')
							return url
						})
				)
			}

			await Promise.all(uploads)

			message.success('Животное успешно создано!')
			onAnimalCreated()
			onClose()
			form.resetFields()
			setPhotoFile(null)
			setDocumentFile(null)
		} catch (error) {
			console.error('Create animal error:', error)
			message.error('Ошибка при создании животного')
		}
	}

	const validateFile = (file: RcFile, type: 'photo' | 'document') => {
		const isValidType = acceptedFileTypes[type].includes(file.type)
		if (!isValidType) {
			message.error(
				`Неподдерживаемый формат файла. Разрешены: ${acceptedFileTypes[
					type
				].join(', ')}`
			)
			return false
		}

		const isLt5M = file.size / 1024 / 1024 < 5
		if (!isLt5M) {
			message.error('Файл должен быть меньше 5MB!')
			return false
		}

		return true
	}

	return (
		<Modal
			title='Добавить животное'
			open={open}
			onOk={handleSubmit}
			onCancel={onClose}
			confirmLoading={isCreating}
			width={800}
			okText='Создать'
			cancelText='Отмена'
		>
			<Form form={form} layout='vertical' className={styles.form}>
				<Form.Item
					name='name'
					label='Имя животного'
					rules={[{ required: true, message: 'Введите имя животного' }]}
				>
					<Input placeholder='Например, Барсик' />
				</Form.Item>

				<Form.Item name='description' label='Описание'>
					<Input.TextArea
						placeholder='Порода, особенности характера и т.д.'
						rows={3}
					/>
				</Form.Item>

				<Form.Item name='birthDate' label='Дата рождения'>
					<DatePicker style={{ width: '100%' }} placeholder='Выберите дату' />
				</Form.Item>

				<Form.Item name='mass' label='Вес (кг)'>
					<Input
						type='number'
						placeholder='Введите вес в килограммах'
						addonAfter='кг'
					/>
				</Form.Item>

				<div className={styles.fileSection}>
					<h4>Фото животного</h4>
					<FileUpload
						beforeUpload={(file: RcFile) => {
							if (!validateFile(file, 'photo')) return false
							setPhotoFile(file)
							return false
						}}
						accept='image/*'
						buttonText='Загрузить фото'
						buttonIcon={<UploadOutlined />}
					/>
					{photoFile && (
						<div className={styles.fileInfo}>
							<span>{photoFile.name}</span>
							<Button type='link' danger onClick={() => setPhotoFile(null)}>
								Удалить
							</Button>
						</div>
					)}
				</div>

				<div className={styles.fileSection}>
					<h4>Документы</h4>
					<Form.Item label='Тип документа'>
						<Select
							value={documentType}
							onChange={setDocumentType}
							options={documentTypes}
							className={styles.docSelect}
						/>
					</Form.Item>
					<FileUpload
						beforeUpload={(file: RcFile) => {
							if (!validateFile(file, 'document')) return false
							setDocumentFile(file)
							return false
						}}
						accept='.pdf,.doc,.docx'
						buttonText='Загрузить документ'
						buttonIcon={<PlusOutlined />}
					/>
					{documentFile && (
						<div className={styles.fileInfo}>
							<span>{documentFile.name}</span>
							<Button type='link' danger onClick={() => setDocumentFile(null)}>
								Удалить
							</Button>
						</div>
					)}
				</div>
			</Form>
		</Modal>
	)
}
```

=== Файл: components/UserAvatarUpload/UserAvatarUpload.tsx ===
```typescript
import { useUser } from '@/features/user/hooks/useUser'
import { UploadOutlined } from '@ant-design/icons'
import { Button, Upload, message } from 'antd'
import { RcFile } from 'antd/es/upload'
import styles from './UserAvatarUpload.module.scss'

interface UserAvatarUploadProps {
	currentPhotoUrl?: string
}

export const UserAvatarUpload = ({
	currentPhotoUrl,
}: UserAvatarUploadProps) => {
	const { uploadPhoto, isUploading } = useUser()

	const handleUpload = async (file: RcFile) => {
		try {
			await uploadPhoto(file)
			message.success('Фото успешно обновлено!')
		} catch (error) {
			message.error('Ошибка загрузки фото')
			console.error('Upload error:', error)
		}
		return false // Prevent default upload behavior
	}

	return (
		<div className={styles.uploadContainer}>
			<img
				src={currentPhotoUrl || 'https://placehold.co/150x150?text=No+Photo'}
				alt='User avatar'
				className={styles.avatar}
			/>
			<Upload
				beforeUpload={handleUpload}
				showUploadList={false}
				accept='image/*'
			>
				<Button icon={<UploadOutlined />} loading={isUploading}>
					Обновить фото
				</Button>
			</Upload>
		</div>
	)
}
```

=== Файл: components/FileUpload/FileUpload.tsx ===
```typescript
import { Button, Upload, UploadProps } from 'antd'

interface FileUploadProps extends UploadProps {
	buttonText: string
	buttonIcon: React.ReactNode
}

export const FileUpload = ({
	buttonText,
	buttonIcon,
	...props
}: FileUploadProps) => {
	return (
		<Upload {...props}>
			<Button icon={buttonIcon}>{buttonText}</Button>
		</Upload>
	)
}
```

=== Файл: layouts/MainLayout/MainLayout.tsx ===
```typescript
import { MenuOutlined } from '@ant-design/icons'
import { Button, Drawer, Layout } from 'antd'
import { useState } from 'react'
import { Outlet } from 'react-router-dom'
import styles from './MainLayout.module.scss'

// Можно взять Layout.Header/Layout.Content/Layout.Footer из antd
const { Header, Content } = Layout

export function MainLayout() {
	const [isDrawerOpen, setIsDrawerOpen] = useState(false)

	function toggleDrawer() {
		setIsDrawerOpen(!isDrawerOpen)
	}

	return (
		<Layout className={styles.mainLayout}>
			<Header className={styles.topBar}>
				<Button
					className={styles.burgerButton}
					icon={<MenuOutlined />}
					onClick={toggleDrawer}
					type='text'
				/>
				<h2 className={styles.appName}>Pet Health Tracker</h2>
			</Header>

			<Drawer
				title='Меню'
				placement='left'
				closable
				onClose={toggleDrawer}
				open={isDrawerOpen}
			>
				{/* Тут ваши пункты меню (ссылки), например */}
				<p>Пункт 1</p>
				<p>Пункт 2</p>
			</Drawer>

			<Content className={styles.contentWrapper}>
				<Outlet />
			</Content>
		</Layout>
	)
}
```

=== Файл: layouts/AuthLayout/AuthLayout.tsx ===
```typescript
import { Layout } from 'antd'
import { AiOutlineSafetyCertificate } from 'react-icons/ai'
import { Outlet } from 'react-router-dom'
import styles from './AuthLayout.module.scss'

// Можно также использовать "Layout.Header" из antd.
export function AuthLayout() {
	return (
		<Layout className={styles.authLayout}>
			<header className={styles.topBar}>
				{/* Лого или простая иконка */}
				<AiOutlineSafetyCertificate className={styles.logoIcon} />
				<h2 className={styles.appName}>Pet Health Tracker</h2>
			</header>

			{/* Основное содержимое (страница /auth/login, /auth/register, /auth/activate) */}
			<div className={styles.contentWrapper}>
				<Outlet />
			</div>
		</Layout>
	)
}
```

=== Файл: features/diary/hooks/useDiary.ts ===
```typescript
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { useToken } from '../../auth/hooks/useToken'
import { diaryApi } from '../api/diaryApi'
import { StatusLogCreateRequest, StatusLogUpdateRequest } from '../api/types'

export const useDiary = (animalId: number) => {
	const queryClient = useQueryClient()
	const { getAccessToken } = useToken()

	// Получение всех записей
	const statusLogsQuery = useQuery({
		queryKey: ['animalStatusLogs', animalId],
		queryFn: () => diaryApi.getStatusLogs(animalId),
		enabled: !!animalId && !!getAccessToken(),
	})

	// Создание записи
	const createMutation = useMutation({
		mutationFn: (data: StatusLogCreateRequest) =>
			diaryApi.createStatusLog(animalId, data),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	// Обновление записи
	const updateMutation = useMutation({
		mutationFn: ({
			statusLogId,
			data,
		}: {
			statusLogId: number
			data: StatusLogUpdateRequest
		}) => diaryApi.updateStatusLog(animalId, statusLogId, data),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	// Удаление записи
	const deleteMutation = useMutation({
		mutationFn: (statusLogId: number) =>
			diaryApi.deleteStatusLog(animalId, statusLogId),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	return {
		statusLogs: statusLogsQuery.data,
		isLoading: statusLogsQuery.isLoading,
		refetchStatusLogs: statusLogsQuery.refetch,

		createStatusLog: createMutation.mutateAsync,
		isCreating: createMutation.isPending,

		updateStatusLog: updateMutation.mutateAsync,
		isUpdating: updateMutation.isPending,

		deleteStatusLog: deleteMutation.mutateAsync,
		isDeleting: deleteMutation.isPending,
	}
}
```

=== Файл: features/diary/hooks/useDiaryFiles.ts ===
```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { diaryApi } from '../api/diaryApi'

export const useDiaryFiles = (animalId: number, statusLogId: number) => {
	const queryClient = useQueryClient()

	const addPhoto = useMutation({
		mutationFn: (file: File) =>
			diaryApi.addStatusLogPhoto(animalId, statusLogId, file),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	const deletePhoto = useMutation({
		mutationFn: (photoId: number) => diaryApi.deleteStatusLogPhoto(photoId),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	const addDocument = useMutation({
		mutationFn: ({ file, type }: { file: File; type: string }) =>
			diaryApi.addStatusLogDocument(animalId, statusLogId, file, type),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	const deleteDocument = useMutation({
		mutationFn: (documentId: number) =>
			diaryApi.deleteStatusLogDocument(documentId),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	return {
		addPhoto: addPhoto.mutateAsync,
		isAddingPhoto: addPhoto.isPending,

		deletePhoto: deletePhoto.mutateAsync,
		isDeletingPhoto: deletePhoto.isPending,

		addDocument: addDocument.mutateAsync,
		isAddingDocument: addDocument.isPending,

		deleteDocument: deleteDocument.mutateAsync,
		isDeletingDocument: deleteDocument.isPending,
	}
}
```

=== Файл: features/diary/hooks/useDiaryAttributes.ts ===
```typescript
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { AttributeRequest } from '../../animal/api/types'
import { useToken } from '../../auth/hooks/useToken'
import { diaryApi } from '../api/diaryApi'

export const useDiaryAttributes = (animalId: number, statusLogId?: number) => {
	const queryClient = useQueryClient()
	const { getAccessToken } = useToken()

	// История атрибутов животного
	const attributeHistoryQuery = useQuery({
		queryKey: ['animalAttributeHistory', animalId],
		queryFn: () => diaryApi.getAttributeHistory(animalId),
		enabled: !!animalId && !!getAccessToken(),
	})

	// Операции с атрибутами записи
	const addAttribute = useMutation({
		mutationFn: (data: AttributeRequest) =>
			diaryApi.addStatusLogAttribute(animalId, statusLogId!, data),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
		},
	})

	const updateAttribute = useMutation({
		mutationFn: ({
			attributeId,
			data,
		}: {
			attributeId: number
			data: AttributeRequest
		}) =>
			diaryApi.updateStatusLogAttribute(
				animalId,
				statusLogId!,
				attributeId,
				data
			),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
			queryClient.invalidateQueries({
				queryKey: ['animalAttributeHistory', animalId],
			})
		},
	})

	const deleteAttribute = useMutation({
		mutationFn: (attributeId: number) =>
			diaryApi.deleteStatusLogAttribute(animalId, statusLogId!, attributeId),
		onSuccess: () => {
			queryClient.invalidateQueries({
				queryKey: ['animalStatusLogs', animalId],
			})
			queryClient.invalidateQueries({
				queryKey: ['animalAttributeHistory', animalId],
			})
		},
	})

	return {
		attributeHistory: attributeHistoryQuery.data,
		isLoadingHistory: attributeHistoryQuery.isLoading,

		addAttribute: addAttribute.mutateAsync,
		isAddingAttribute: addAttribute.isPending,

		updateAttribute: updateAttribute.mutateAsync,
		isUpdatingAttribute: updateAttribute.isPending,

		deleteAttribute: deleteAttribute.mutateAsync,
		isDeletingAttribute: deleteAttribute.isPending,
	}
}
```

=== Файл: features/diary/api/types.ts ===
```typescript
import {
	AttributeRequest,
	AttributeResponse,
	DocumentResponse,
} from '../../animal/api/types'

export interface StatusLogCreateRequest {
	notes?: string
	logDate?: string // ISO date
	attributes?: AttributeRequest[]
}

export interface StatusLogUpdateRequest {
	notes?: string
	logDate?: string
}

export interface StatusLogResponse {
	id: number
	logDate: string
	notes?: string
	photos: string[] // objectKeys
	documents: DocumentResponse[]
	attributes: AttributeResponse[]
}

export interface AttributeHistoryResponse {
	attributeName: string
	oldValue?: string
	changedAt: string
	changedBy: string
}

export interface StatusLogWithHistory extends StatusLogResponse {
	attributeHistory: AttributeHistoryResponse[]
}
```

=== Файл: features/diary/api/diaryApi.ts ===
```typescript
import { AttributeResponse } from '@/features/animal/api/types'
import { apiClient } from '../../../api/client'
import {
	AttributeHistoryResponse,
	StatusLogCreateRequest,
	StatusLogResponse,
	StatusLogWithHistory,
} from './types'

export const diaryApi = {
	// Основные операции с записями
	createStatusLog: (animalId: number, data: StatusLogCreateRequest) =>
		apiClient
			.post<StatusLogResponse>(`/animals/${animalId}/status-logs`, data)
			.then(r => r.data),

	getStatusLog: (animalId: number, statusLogId: number) =>
		apiClient
			.get<StatusLogWithHistory>(
				`/animals/${animalId}/status-logs/${statusLogId}`
			)
			.then(r => r.data),
	
	deleteStatusLog: (animalId: number, statusLogId: number) =>
		apiClient
			.delete(`/animals/${animalId}/status-logs/${statusLogId}`)
			.then(r => r.data),


	deleteStatusLogPhoto: (photoId: number) =>
		apiClient
			.delete(`/animals/status-logs/photos/${photoId}`)
			.then(r => r.data),

	
	deleteStatusLogDocument: (documentId: number) =>
		apiClient
			.delete(`/animals/status-logs/documents/${documentId}`)
			.then(r => r.data),

	deleteStatusLogAttribute: (
		animalId: number,
		statusLogId: number,
		attributeId: number
	) =>
		apiClient
			.delete(
				`/animals/${animalId}/status-logs/${statusLogId}/attributes/${attributeId}`
			)
			.then(r => r.data),

	getAttributeHistory: (animalId: number) =>
		apiClient
			.get<AttributeHistoryResponse[]>(
				`/animals/${animalId}/attributes/history`
			)
			.then(r => r.data),

	getStatusLogs: (animalId: number) =>
		apiClient.get<StatusLogResponse[]>(`/animals/${animalId}/status-logs`),

	addStatusLog: (animalId: number, data: { notes: string; logDate: string }) =>
		apiClient.post<StatusLogResponse>(`/animals/${animalId}/status-logs`, data),

	updateStatusLog: (
		animalId: number,
		statusLogId: number,
		data: { notes: string }
	) =>
		apiClient.put<StatusLogResponse>(
			`/animals/${animalId}/status-logs/${statusLogId}`,
			data
		),

	addStatusLogPhoto: (animalId: number, statusLogId: number, file: File) => {
		const formData = new FormData()
		formData.append('file', file)
		return apiClient.post<string>(
			`/animals/${animalId}/status-logs/${statusLogId}/photos`,
			formData,
			{ headers: { 'Content-Type': 'multipart/form-data' } }
		)
	},

	addStatusLogDocument: (
		animalId: number,
		statusLogId: number,
		file: File,
		type: string
	) => {
		const formData = new FormData()
		formData.append('file', file)
		formData.append('type', type)
		return apiClient.post<string>(
			`/animals/${animalId}/status-logs/${statusLogId}/documents`,
			formData,
			{ headers: { 'Content-Type': 'multipart/form-data' } }
		)
	},

	addStatusLogAttribute: (
		animalId: number,
		statusLogId: number,
		data: { name: string; value: string }
	) =>
		apiClient.post<AttributeResponse>(
			`/animals/${animalId}/status-logs/${statusLogId}/attributes`,
			data
		),

	updateStatusLogAttribute: (
		animalId: number,
		statusLogId: number,
		attributeId: number,
		data: { name?: string; value?: string }
	) =>
		apiClient.patch<AttributeResponse>(
			`/animals/${animalId}/status-logs/${statusLogId}/attributes/${attributeId}`,
			data
		),
}
```

=== Файл: features/auth/hooks/useAuth.ts ===
```typescript
import { useMutation } from '@tanstack/react-query'
import { authApi } from '../api/authApi'
import { useToken } from './useToken'

export const useAuth = () => {
	const { setTokens, clearTokens } = useToken()

	const registerMutation = useMutation({
		mutationFn: authApi.register,
	})

	const activateMutation = useMutation({
		mutationFn: authApi.activate,
	})

	const loginMutation = useMutation({
		mutationFn: authApi.login,
		onSuccess: data => {
			setTokens({
				accessToken: data.access_token,
				refreshToken: data.refresh_token,
			})
		},
	})

	const logout = () => {
		clearTokens()
		// Дополнительные действия при выходе
	}

	return {
		register: registerMutation.mutateAsync,
		isRegistering: registerMutation.isPending,

		activate: activateMutation.mutateAsync,
		isActivating: activateMutation.isPending,

		login: loginMutation.mutateAsync,
		isLoggingIn: loginMutation.isPending,

		logout,
	}
}
```

=== Файл: features/auth/hooks/useToken.ts ===
```typescript
import { useEffect } from 'react'
import { apiClient } from '../../../api/client'

export const useToken = () => {
	const setTokens = (tokens: { accessToken: string; refreshToken: string }) => {
		localStorage.setItem('accessToken', tokens.accessToken)
		localStorage.setItem('refreshToken', tokens.refreshToken)
		apiClient.defaults.headers['Authorization'] = `Bearer ${tokens.accessToken}`
	}

	const clearTokens = () => {
		localStorage.removeItem('accessToken')
		localStorage.removeItem('refreshToken')
		delete apiClient.defaults.headers['Authorization']
	}

	const getAccessToken = () => localStorage.getItem('accessToken')

	// Инициализация при монтировании
	useEffect(() => {
		const token = localStorage.getItem('accessToken')
		if (token) {
			apiClient.defaults.headers['Authorization'] = `Bearer ${token}`
		}
	}, [])

	return { setTokens, clearTokens, getAccessToken }
}
```

=== Файл: features/auth/api/types.ts ===
```typescript
// Регистрация
export interface RegisterRequest {
	username: string
	email: string
	password: string
}

export interface RegisterResponse {
	email: string
	username: string
	isActivated: boolean
}

// Активация
export interface ActivateRequest {
	token: string
}

// Авторизация
export interface LoginRequest {
	indentifier: string // email или username
	password: string
}

export interface Tokens {
	access_token: string
	refresh_token: string
	access_expires_at: string
	refresh_expires_at: string
}

export interface LoginResponse extends Tokens {
	user: {
		email: string
		username: string
	}
}
```

=== Файл: features/auth/api/authApi.ts ===
```typescript
import { apiClient } from '../../../api/client'
import {
	LoginRequest,
	LoginResponse,
	RegisterRequest,
	RegisterResponse,
} from './types'

export const authApi = {
	register: (data: RegisterRequest) =>
		apiClient
			.post<RegisterResponse>('/auth/register', data)
			.then(response => response.data),

	activate: (token: string) =>
		apiClient
			.get<void>('/auth/activate-account', {
				params: { token },
			})
			.then(r => r.data),

	login: (data: LoginRequest) =>
		apiClient
			.post<LoginResponse>('/auth/authenticate', data)
			.then(response => response.data),
}
```

=== Файл: features/user/hooks/useUser.ts ===
```typescript
import { useMutation, useQuery } from '@tanstack/react-query'
import { UserUpdateRequest } from '../api/types'
import { userApi } from '../api/userApi'

export const useUser = () => {
	const {
		data: currentUser,
		isPending,
		refetch,
	} = useQuery({
		queryKey: ['currentUser'],
		queryFn: userApi.getCurrentUser,
	})

	const updateUser = useMutation({
		mutationFn: (data: UserUpdateRequest) => userApi.updateUser(data),
		onSuccess: () => refetch(),
	})

	const uploadPhoto = useMutation({
		mutationFn: (file: File) => userApi.uploadPhoto(file),
		onSuccess: () => refetch(),
	})

	return {
		currentUser,
		isPending,
		updateUser: updateUser.mutateAsync,
		isUpdating: updateUser.isPending,
		uploadPhoto: uploadPhoto.mutateAsync,
		isUploading: uploadPhoto.isPending,
	}
}
```

=== Файл: features/user/api/types.ts ===
```typescript
// Обновление данных пользователя
export interface UserUpdateRequest {
	firstName?: string
	lastName?: string
	city?: string
	aboutMe?: string
}

export interface UserResponse {
	username: string
	firstName?: string
	lastName?: string
	city?: string
	aboutMe?: string
	photoUrl?: string
}

// Загрузка фото
export interface S3FileResponse {
	objectKey: string
	presignedUrl: string
}
```

=== Файл: features/user/api/userApi.ts ===
```typescript
import { apiClient } from '../../../api/client'
import { S3FileResponse, UserResponse, UserUpdateRequest } from './types'

export const userApi = {
	getCurrentUser: () =>
		apiClient.get<UserResponse>('/users/me').then(r => r.data),

	updateUser: (data: UserUpdateRequest) =>
		apiClient.patch<UserResponse>('/users/me', data).then(r => r.data),

	uploadPhoto: (file: File) => {
		const formData = new FormData()
		formData.append('file', file)
		return apiClient
			.post<S3FileResponse>('/users/me/photo', formData, {
				headers: {
					'Content-Type': 'multipart/form-data',
				},
			})
			.then(r => r.data)
	},
}
```

=== Файл: features/animal/hooks/useAnimal.ts ===
```typescript
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { animalApi } from '../api/animalApi'
import { AnimalCreateRequest, AnimalResponse } from '../api/types'

export const useAnimal = (animalId?: number) => {
	const queryClient = useQueryClient()

	const {
		data: animal,
		isPending,
		error,
	} = useQuery<AnimalResponse>({
		queryKey: ['animal', animalId],
		queryFn: () => animalApi.getAnimal(animalId!),
		enabled: !!animalId,
	})

	const createMutation = useMutation({
		mutationFn: animalApi.createAnimal,
		onSuccess: () => {
			queryClient.invalidateQueries({ queryKey: ['userAnimals'] })
		},
	})

	const updateMutation = useMutation({
		mutationFn: ({
			id,
			data,
		}: {
			id: number
			data: Partial<AnimalCreateRequest>
		}) => animalApi.updateAnimal(id, data),
		onSuccess: (_, { id }) => {
			queryClient.invalidateQueries({ queryKey: ['animal', id] })
			queryClient.invalidateQueries({ queryKey: ['userAnimals'] })
		},
	})

	const deleteMutation = useMutation({
		mutationFn: (id: number) => animalApi.deleteAnimal(id),
		onSuccess: () => {
			queryClient.invalidateQueries({ queryKey: ['userAnimals'] })
		},
	})

	return {
		animal,
		isPending,
		error,
		createAnimal: createMutation.mutateAsync,
		isCreating: createMutation.isPending,
		updateAnimal: updateMutation.mutateAsync,
		isUpdating: updateMutation.isPending,
		deleteAnimal: deleteMutation.mutateAsync,
		isDeleting: deleteMutation.isPending,
	}
}
```

=== Файл: features/animal/hooks/useAnalytics.ts ===
```typescript
import { useQuery } from '@tanstack/react-query'
import { useToken } from '../../auth/hooks/useToken'
import { analyticsApi } from '../api/analyticsApi'

export const useAnalytics = (animalId?: number) => {
	const { getAccessToken } = useToken()

	return useQuery({
		queryKey: ['animalAnalytics', animalId],
		queryFn: () => analyticsApi.getAnimalAnalytics(animalId!),
		enabled: !!animalId && !!getAccessToken(),
		select: data =>
			data.map(item => ({
				...item,
				changes: item.changes.map(change => ({
					...change,
					date: new Date(change.date).toLocaleDateString(),
				})),
			})),
	})
}
```

=== Файл: features/animal/hooks/useExport.ts ===
```typescript
import { useMutation } from '@tanstack/react-query'
import { exportApi } from '../api/exportApi'

export const useExport = () => {
	return useMutation({
		mutationFn: exportApi.exportAnimalToPdf,
		onSuccess: () => {
			// Можно добавить уведомление об успешном экспорте
			console.log('PDF exported successfully')
		},
		onError: error => {
			console.error('Export failed:', error)
		},
	})
}
```

=== Файл: features/animal/hooks/useUserAnimals.ts ===
```typescript
import { useQuery } from '@tanstack/react-query'
import { animalApi } from '../api/animalApi'

export const useUserAnimals = () => {
	return useQuery({
		queryKey: ['userAnimals'],
		queryFn: animalApi.getUserAnimals,
	})
}
```

=== Файл: features/animal/hooks/useAnimalAttributes.ts ===
```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { animalApi } from '../api/animalApi'
import { AttributeRequest, AttributeResponse } from '../api/types'

export const useAnimalAttributes = (animalId: number) => {
	const queryClient = useQueryClient()

	const addAttribute = useMutation<AttributeResponse, Error, AttributeRequest>({
		mutationFn: data => animalApi.addAttribute(animalId, data),
		onSuccess: () => {
			queryClient.invalidateQueries({ queryKey: ['animal', animalId] })
		},
	})

	const updateAttribute = useMutation<
		AttributeResponse,
		Error,
		{ attributeId: number; data: AttributeRequest }
	>({
		mutationFn: ({ attributeId, data }) =>
			animalApi.updateAttribute(animalId, attributeId, data),
		onSuccess: () => {
			queryClient.invalidateQueries({ queryKey: ['animal', animalId] })
		},
	})

	const deleteAttribute = useMutation<void, Error, number>({
		mutationFn: attributeId => animalApi.deleteAttribute(animalId, attributeId),
		onSuccess: () => {
			queryClient.invalidateQueries({ queryKey: ['animal', animalId] })
		},
	})

	return {
		addAttribute: addAttribute.mutateAsync,
		isAdding: addAttribute.isPending,
		updateAttribute: updateAttribute.mutateAsync,
		isUpdating: updateAttribute.isPending,
		deleteAttribute: deleteAttribute.mutateAsync,
		isDeleting: deleteAttribute.isPending,
	}
}
```

=== Файл: features/animal/api/analyticsApi.ts ===
```typescript
import { apiClient } from '../../../api/client'
import { AnimalResponse } from './types'

export interface AnimalAnalyticsResponse {
	attributeName: string
	changes: {
		date: string
		value: string
		changedBy: string
	}[]
	stats?: {
		minValue: string
		maxValue: string
		avgValue: number
	}
}

export const analyticsApi = {
	getAnimalAnalytics: (animalId: number) =>
		apiClient
			.get<AnimalAnalyticsResponse[]>(`/animals/${animalId}/analytics`)
			.then(r => r.data),

	getUserAnimals: () =>
		apiClient.get<AnimalResponse[]>('/users/me/animals').then(r => r.data),
}
```

=== Файл: features/animal/api/types.ts ===
```typescript
export interface AnimalCreateRequest {
	name: string
	description?: string
	birthDate?: string
	mass?: number
	attributes?: AttributeRequest[]
}

export interface AnimalResponse {
	id: number
	name: string
	description?: string
	birthDate?: string
	mass?: number
	attributes: AttributeResponse[]
	photos: string[]
	documents: string[]
}

export interface DocumentResponse {
	id: number
	type: string
	url: string
}

export interface AttributeRequest {
	name: string
	value: string
}

export interface AttributeResponse {
	id: number
	name: string
	value?: string
}
export interface AnimalUpdateRequest {
	name?: string
	description?: string
	birthDate?: string
	mass?: number
}
export interface S3UploadResponse {
	objectKey: string
	presignedUrl: string
}
export interface AnimalPhotoUploadResponse {
	url: string // Прямая ссылка на фото
}

export interface AnimalDocumentUploadResponse {
	url: string // Прямая ссылка на документ
}
```

=== Файл: features/animal/api/exportApi.ts ===
```typescript
import { apiClient } from '../../../api/client'

// export const exportApi = {
// 	exportAnimalToPdf: (animalId: number) =>
// 		apiClient
// 			.get(`/animals/${animalId}/export/pdf`, {
// 				responseType: 'blob',
// 				headers: {
// 					Accept: 'application/pdf',
// 				},
// 			})
// 			.then(response => {
// 				const url = window.URL.createObjectURL(new Blob([response.data]))
// 				const link = document.createElement('a')
// 				link.href = url
// 				link.setAttribute('download', `animal_${animalId}_report.pdf`)
// 				document.body.appendChild(link)
// 				link.click()
// 				document.body.removeChild(link)
// 				return response
// 			}),
// }
export const exportApi = {
	exportAnimalToPdf: async (animalId: number) => {
		const response = await apiClient.get(`/animals/${animalId}/export/pdf`, {
			responseType: 'blob',
			headers: {
				Accept: 'application/pdf',
			},
		})
		return response.data // Возвращаем только данные (Blob)
	},
}
```

=== Файл: features/animal/api/animalApi.ts ===
```typescript
import { apiClient } from '../../../api/client'
import {
	AnimalCreateRequest,
	AnimalDocumentUploadResponse,
	AnimalPhotoUploadResponse,
	AnimalResponse,
	AttributeRequest,
} from './types'

export const animalApi = {
	// Основные операции с животными
	createAnimal: (data: AnimalCreateRequest) =>
		apiClient.post<AnimalResponse>('/animals', data).then(res => res.data),

	getAnimal: (id: number) =>
		apiClient.get<AnimalResponse>(`/animals/${id}`).then(res => res.data),

	updateAnimal: (id: number, data: Partial<AnimalCreateRequest>) =>
		apiClient
			.patch<AnimalResponse>(`/animals/${id}`, data)
			.then(res => res.data),

	deleteAnimal: (id: number) =>
		apiClient.delete(`/animals/${id}`).then(res => res.data),

	// Файлы
	uploadAnimalPhoto: (animalId: number, file: File) => {
		const formData = new FormData()
		formData.append('file', file)
		return apiClient
			.post<AnimalPhotoUploadResponse>(
				`/animals/${animalId}/photos`,
				formData,
				{ headers: { 'Content-Type': 'multipart/form-data' } }
			)
			.then(res => res.data)
	},

	uploadAnimalDocument: (animalId: number, file: File, type: string) => {
		const formData = new FormData()
		formData.append('file', file)
		formData.append('type', type)
		return apiClient
			.post<AnimalDocumentUploadResponse>(
				`/animals/${animalId}/documents`,
				formData,
				{ headers: { 'Content-Type': 'multipart/form-data' } }
			)
			.then(res => res.data)
	},
	deleteAnimalPhoto: (photoUrl: string) => {
		return apiClient
			.delete(`/animals/photos`, {
				data: { url: photoUrl },
			})
			.then(res => res.data)
	},

	deleteAnimalDocument: (documentUrl: string) => {
		return apiClient
			.delete(`/animals/documents`, {
				data: { url: documentUrl },
			})
			.then(res => res.data)
	},
	// Атрибуты
	addAttribute: (animalId: number, data: AttributeRequest) =>
		apiClient
			.post(`/animals/${animalId}/attributes`, data)
			.then(res => res.data),

	updateAttribute: (
		animalId: number,
		attributeId: number,
		data: AttributeRequest
	) =>
		apiClient
			.patch(`/animals/${animalId}/attributes/${attributeId}`, data)
			.then(res => res.data),

	deleteAttribute: (animalId: number, attributeId: number) =>
		apiClient
			.delete(`/animals/${animalId}/attributes/${attributeId}`)
			.then(res => res.data),
	getUserAnimals: () =>
		apiClient.get<AnimalResponse[]>('/users/me/animals').then(res => res.data),
}
```

=== Файл: api/client.ts ===
```typescript
import axios from 'axios'

export const apiClient = axios.create({
	baseURL: import.meta.env.VITE_API_URL || '/api',
	withCredentials: true,
})

apiClient.interceptors.response.use(
	response => response,
	error => {
		if (error.response?.status === 401) {
			console.log('Ошибка атворизации')
		}
		return Promise.reject(error)
	}
)

// Инициализация токена при старте
const token = localStorage.getItem('accessToken')
if (token) {
	apiClient.defaults.headers['Authorization'] = `Bearer ${token}`
}
```

=== Файл: utils/s3Upload.ts ===
```typescript
import axios from 'axios'

export const uploadToS3 = async (presignedUrl: string, file: File) => {
	try {
		await axios.put(presignedUrl, file, {
			headers: {
				'Content-Type': file.type,
			},
		})
		return true
	} catch (error) {
		console.error('S3 upload failed:', error)
		return false
	}
}
```

